// =============================================================================
// BERK Hardware Bridge - Modbus RTU Demo
// EndÃ¼striyel PLC ve sensÃ¶r iletiÅŸimi
// =============================================================================

kullan std::modbus

yazdÄ±r("=== BERK Modbus RTU Demo ===\n")

// -----------------------------------------------------------------------------
// Modbus Temelleri
// -----------------------------------------------------------------------------

yazdÄ±r("ğŸ­ Modbus RTU ProtokolÃ¼")
yazdÄ±r("-" * 40)

yazdÄ±r("""
Modbus, endÃ¼striyel otomasyon iÃ§in standart protokoldÃ¼r.
PLC, sensÃ¶r, motor sÃ¼rÃ¼cÃ¼ gibi cihazlarla haberleÅŸmeyi saÄŸlar.

Veri Tipleri:
  â€¢ Coil         - Dijital Ã§Ä±kÄ±ÅŸ (1 bit, R/W)
  â€¢ Discrete     - Dijital giriÅŸ (1 bit, R)
  â€¢ Holding Reg  - 16-bit register (R/W)
  â€¢ Input Reg    - 16-bit register (R)
""")

// -----------------------------------------------------------------------------
// BaÄŸlantÄ± Ã–rneÄŸi
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ”Œ BaÄŸlantÄ± Kurma:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
kullan std::modbus

// Basit baÄŸlantÄ± (RTU modu, varsayÄ±lan ayarlar)
olsun plc = modbus::connect("COM4", 9600, 1)
//                          ^port   ^baud ^slave_id

// GeliÅŸmiÅŸ baÄŸlantÄ±
olsun plc = modbus::connect_advanced(
    "COM4",     // Port
    1,          // Slave ID
    "rtu",      // Mod: "rtu" veya "ascii"
    9600,       // Baud rate
    8,          // Data bits
    "none",     // Parity: "none", "even", "odd"
    1           // Stop bits
)

// BaÄŸlantÄ± kontrolÃ¼
eÄŸer modbus::is_connected(plc) ise
    yazdÄ±r("PLC baÄŸlÄ±!")
son
""")

// -----------------------------------------------------------------------------
// Coil Okuma/Yazma (Dijital I/O)
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ’¡ Coil (Dijital Ã‡Ä±kÄ±ÅŸ) Ä°ÅŸlemleri:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
// Tek coil oku (adres 0)
olsun durum = modbus::read_coils(plc, 0, 1)
yazdÄ±r("Coil 0: {}", durum[0])

// 8 coil oku
olsun durumlar = modbus::read_coils(plc, 0, 8)
yazdÄ±r("Coil'ler: {:?}", durumlar)

// Tek coil yaz
modbus::write_coil(plc, 0, doÄŸru)   // AÃ§
modbus::write_coil(plc, 0, yanlÄ±ÅŸ)  // Kapat

// Ã‡oklu coil yaz
modbus::write_coils(plc, 0, [doÄŸru, yanlÄ±ÅŸ, doÄŸru, doÄŸru])
""")

// -----------------------------------------------------------------------------
// Register Okuma/Yazma
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ“Š Register Ä°ÅŸlemleri:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
// Holding Register oku (adres 100, 4 adet)
olsun degerler = modbus::read_holding_registers(plc, 100, 4)
yazdÄ±r("DeÄŸerler: {:?}", degerler)

// Input Register oku (salt okunur)
olsun sensorler = modbus::read_input_registers(plc, 0, 8)

// Tek register yaz
modbus::write_register(plc, 100, 1000)

// Ã‡oklu register yaz
modbus::write_registers(plc, 100, [1000, 2000, 3000, 4000])
""")

// -----------------------------------------------------------------------------
// Ã–zel Veri Tipleri
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ”¢ Ã–zel Veri Tipleri:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
// 16-bit signed integer
olsun sicaklik = modbus::read_int16(plc, 100)
yazdÄ±r("SÄ±caklÄ±k: {}Â°C", sicaklik / 10.0)

// 32-bit signed integer (2 register)
olsun sayac = modbus::read_int32(plc, 200)
yazdÄ±r("SayaÃ§: {}", sayac)

// IEEE 754 Float (2 register)
olsun basinc = modbus::read_float(plc, 300)
yazdÄ±r("BasÄ±nÃ§: {:.2f} bar", basinc)

// Float yaz
modbus::write_float(plc, 300, 25.5)

// 32-bit integer yaz
modbus::write_int32(plc, 200, 123456)
""")

// -----------------------------------------------------------------------------
// Cihaz Tarama
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ” Modbus AÄŸÄ± Tarama:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
// Slave ID 1-10 arasÄ±nÄ± tara
olsun cihazlar = modbus::scan(plc, 1, 10)

her cihaz iÃ§in cihazlar yap
    yazdÄ±r("Cihaz bulundu - ID: {}", cihaz)
son

// Aktif slave ID deÄŸiÅŸtir
modbus::set_slave_id(plc, 2)
""")

// -----------------------------------------------------------------------------
// SÄ±caklÄ±k Okuma Ã–rneÄŸi
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸŒ¡ï¸  Tam Ã–rnek: SÄ±caklÄ±k MonitÃ¶rÃ¼")
yazdÄ±r("-" * 40)

yazdÄ±r("""
kullan std::modbus
kullan std::time

// SensÃ¶re baÄŸlan
olsun sensor = modbus::connect("COM4", 9600, 1)

// Timeout ayarla
modbus::set_timeout(sensor, 1000)

yazdÄ±r("SÄ±caklÄ±k izleme baÅŸladÄ±...")
yazdÄ±r("Ã‡Ä±kmak iÃ§in Ctrl+C")

dÃ¶ngÃ¼ yap
    dene yap
        // Register 0'dan sÄ±caklÄ±k oku (x10 format)
        olsun raw = modbus::read_holding_registers(sensor, 0, 1)
        olsun sicaklik = raw[0] / 10.0
        
        // Zaman damgasÄ±
        olsun simdi = time::now()
        yazdÄ±r("[{}] SÄ±caklÄ±k: {:.1f}Â°C", simdi, sicaklik)
        
        // Alarm kontrolÃ¼
        eÄŸer sicaklik > 30.0 ise
            yazdÄ±r("âš ï¸  UYARI: YÃ¼ksek sÄ±caklÄ±k!")
        son
    yakala hata yap
        yazdÄ±r("âŒ Okuma hatasÄ±: {}", hata)
    son
    
    bekle(1000)
son

modbus::disconnect(sensor)
""")

yazdÄ±r("\nâœ… Modbus demo tamamlandÄ±!")
