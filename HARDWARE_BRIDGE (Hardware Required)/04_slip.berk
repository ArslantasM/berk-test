// =============================================================================
// BERK Hardware Bridge - SLIP Demo
// RFC 1055 Serial Line Internet Protocol
// =============================================================================

kullan std::slip

yazdÄ±r("=== BERK SLIP Protocol Demo ===\n")

// -----------------------------------------------------------------------------
// SLIP Temelleri
// -----------------------------------------------------------------------------

yazdÄ±r("ğŸ“¦ SLIP (Serial Line Internet Protocol)")
yazdÄ±r("-" * 40)

yazdÄ±r("""
SLIP, seri hat Ã¼zerinden gÃ¼venilir paket iletimi saÄŸlar.

Ã–zel Karakterler:
  END  (0xC0) - Paket sonu iÅŸareti
  ESC  (0xDB) - Escape karakteri
  
Escape Dizileri:
  0xC0 â†’ 0xDB 0xDC (END in data)
  0xDB â†’ 0xDB 0xDD (ESC in data)

AvantajlarÄ±:
  â€¢ Basit implementasyon
  â€¢ DÃ¼ÅŸÃ¼k overhead
  â€¢ GÃ¼venilir Ã§erÃ§eveleme
""")

// -----------------------------------------------------------------------------
// Temel KullanÄ±m
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ”Œ Temel KullanÄ±m:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
kullan std::slip

// Port aÃ§
olsun port = slip::open("COM5", 115200)

// Paket gÃ¶nder
slip::send(port, [0x01, 0x02, 0x03, 0x04])

// String gÃ¶nder
slip::send_string(port, "Merhaba DÃ¼nya!")

// Paket al (1 saniye timeout)
olsun paket = slip::receive(port)
yazdÄ±r("AlÄ±nan: {:?}", paket)

// Ã–zel timeout ile al
olsun paket = slip::receive(port, 5000)  // 5 saniye

// Port kapat
slip::close(port)
""")

// -----------------------------------------------------------------------------
// Encode/Decode Ä°ÅŸlemleri
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ”„ Encode/Decode:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
// Ham veriyi SLIP formatÄ±na Ã§evir
olsun veri = [0x01, 0xC0, 0xDB, 0x04]  // 0xC0 ve 0xDB Ã¶zel!
olsun encoded = slip::encode(veri)
yazdÄ±r("Encoded: {:?}", encoded)
// SonuÃ§: [0x01, 0xDB, 0xDC, 0xDB, 0xDD, 0x04, 0xC0]

// SLIP formatÄ±ndan Ã§Ã¶z
olsun decoded = slip::decode(encoded)
yazdÄ±r("Decoded: {:?}", decoded)
// SonuÃ§: [0x01, 0xC0, 0xDB, 0x04]
""")

// -----------------------------------------------------------------------------
// Paket YapÄ±sÄ±
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ“‹ YapÄ±landÄ±rÄ±lmÄ±ÅŸ Paketler:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
// Komut paketi oluÅŸtur
// Format: [CMD, LEN_HI, LEN_LO, PAYLOAD...]
olsun komut = slip::build_packet(0x10, [0xAA, 0xBB, 0xCC])
yazdÄ±r("Paket: {:?}", komut)
// SonuÃ§: [0x10, 0x00, 0x03, 0xAA, 0xBB, 0xCC]

// Paketi Ã§Ã¶zÃ¼mle
olsun [cmd, payload] = slip::parse_packet(paket)
yazdÄ±r("Komut: 0x{:02X}", cmd)
yazdÄ±r("Payload: {:?}", payload)
""")

// -----------------------------------------------------------------------------
// Request/Response Paterni
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ” Ä°stek/YanÄ±t Paterni:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
// Komut gÃ¶nder ve yanÄ±t bekle
olsun yanit = slip::request(port, [0x01, 0x00], 1000)
yazdÄ±r("YanÄ±t: {:?}", yanit)

// Veri hazÄ±r mÄ± kontrol et
eÄŸer slip::available(port) ise
    olsun veri = slip::receive(port)
    // iÅŸle...
son
""")

// -----------------------------------------------------------------------------
// Tam Ã–rnek: SensÃ¶r ProtokolÃ¼
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ“¡ Tam Ã–rnek: SensÃ¶r HaberleÅŸme")
yazdÄ±r("-" * 40)

yazdÄ±r("""
kullan std::slip

// Komut tanÄ±mlarÄ±
sabit CMD_PING        = 0x00
sabit CMD_GET_TEMP    = 0x01
sabit CMD_GET_HUMID   = 0x02
sabit CMD_SET_LED     = 0x10
sabit CMD_RESPONSE    = 0x80

// SensÃ¶r modÃ¼lÃ¼ne baÄŸlan
olsun sensor = slip::open("COM5", 115200)

// Ping gÃ¶nder
yazdÄ±r("Ping gÃ¶nderiliyor...")
olsun yanit = slip::request(sensor, [CMD_PING], 1000)
eÄŸer yanit[0] == (CMD_PING | CMD_RESPONSE) ise
    yazdÄ±r("âœ“ SensÃ¶r yanÄ±t verdi!")
son

// SÄ±caklÄ±k oku
yazdÄ±r("SÄ±caklÄ±k okunuyor...")
olsun [cmd, veri] = slip::request(sensor, [CMD_GET_TEMP], 1000)
olsun sicaklik = (veri[0] << 8 | veri[1]) / 100.0
yazdÄ±r("SÄ±caklÄ±k: {:.2f}Â°C", sicaklik)

// Nem oku
yazdÄ±r("Nem okunuyor...")
olsun [cmd, veri] = slip::request(sensor, [CMD_GET_HUMID], 1000)
olsun nem = (veri[0] << 8 | veri[1]) / 100.0
yazdÄ±r("Nem: {:.1f}%", nem)

// LED'i aÃ§
yazdÄ±r("LED aÃ§Ä±lÄ±yor...")
slip::send(sensor, [CMD_SET_LED, 0x01])

slip::close(sensor)
yazdÄ±r("BaÄŸlantÄ± kapatÄ±ldÄ±.")
""")

// -----------------------------------------------------------------------------
// ESP32 TarafÄ± Ã–rnek Kodu
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ’» ESP32 Firmware Ã–rneÄŸi (C++):")
yazdÄ±r("-" * 40)

yazdÄ±r("""
// ESP32 tarafÄ±nda SLIP handler
#include <Arduino.h>

#define END     0xC0
#define ESC     0xDB
#define ESC_END 0xDC
#define ESC_ESC 0xDD

void sendSLIP(uint8_t* data, size_t len) {
    for (size_t i = 0; i < len; i++) {
        if (data[i] == END) {
            Serial.write(ESC);
            Serial.write(ESC_END);
        } else if (data[i] == ESC) {
            Serial.write(ESC);
            Serial.write(ESC_ESC);
        } else {
            Serial.write(data[i]);
        }
    }
    Serial.write(END);
}

void handleCommand(uint8_t cmd, uint8_t* payload, size_t len) {
    switch (cmd) {
        case 0x00: // PING
            sendSLIP((uint8_t[]){0x80}, 1);
            break;
        case 0x01: // GET_TEMP
            int16_t temp = readTemperature() * 100;
            sendSLIP((uint8_t[]){0x81, temp >> 8, temp & 0xFF}, 3);
            break;
    }
}
""")

yazdÄ±r("\nâœ… SLIP demo tamamlandÄ±!")
