// =============================================================================
// BERK Hardware Bridge - BinProto Demo
// Ã–zel Binary Protokol Framework
// =============================================================================

kullan std::binproto

yazdÄ±r("=== BERK BinProto Demo ===\n")

// -----------------------------------------------------------------------------
// BinProto Nedir?
// -----------------------------------------------------------------------------

yazdÄ±r("ğŸ”§ BinProto - Ã–zel Binary Protokol Framework")
yazdÄ±r("-" * 40)

yazdÄ±r("""
BinProto, kendi ihtiyaÃ§larÄ±nÄ±za gÃ¶re Ã¶zelleÅŸtirilebilir
binary protokol oluÅŸturmanÄ±zÄ± saÄŸlar.

Ã–zellikler:
  â€¢ Ã–zelleÅŸtirilebilir header/footer
  â€¢ Ã‡oklu checksum algoritmalarÄ±
  â€¢ HazÄ±r preset'ler
  â€¢ Otomatik deÄŸer kodlama/Ã§Ã¶zme
  â€¢ CRC hesaplama
""")

// -----------------------------------------------------------------------------
// Preset Protokoller
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ“¦ HazÄ±r Preset Protokoller:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
Preset       Header      Checksum    Footer
--------------------------------------------------
"standard"   AA 55       XOR         0D 0A
"arduino"    3C (<)      SUM         3E (>)
"modbus_like" (yok)      CRC16       (yok)
"simple"     FF          (yok)       (yok)
"sensor"     02 (STX)    XOR         03 (ETX)
""")

yazdÄ±r("""
kullan std::binproto

// Preset kullan
olsun proto = binproto::create_preset("arduino")

// Veya Ã¶zel protokol oluÅŸtur
olsun proto = binproto::create_simple(
    [0xAA, 0x55],   // Header
    "crc16",        // Checksum: "xor", "sum", "crc16", "crc32", "none"
    [0x0D, 0x0A]    // Footer
)
""")

// -----------------------------------------------------------------------------
// BaÄŸlantÄ± ve Ä°letiÅŸim
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ”Œ BaÄŸlantÄ± ve Ä°letiÅŸim:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
// Protokol ile port aÃ§
olsun conn = binproto::open(proto, "COM6", 115200)

// Protokol bilgisi
olsun bilgi = binproto::get_info(conn)
yazdÄ±r("Header: {:?}", bilgi["header"])
yazdÄ±r("Checksum: {}", bilgi["checksum_type"])

// Komut gÃ¶nder (otomatik Ã§erÃ§eveleme)
binproto::send(conn, 0x01, [0x10, 0x20, 0x30])
// GÃ¶nderilen: [HEADER][CMD][LEN][DATA...][CHECKSUM][FOOTER]

// YanÄ±t al
olsun [cmd, payload] = binproto::receive(conn)
yazdÄ±r("Komut: 0x{:02X}", cmd)
yazdÄ±r("Veri: {:?}", payload)

// Ä°stek/YanÄ±t (tek Ã§aÄŸrÄ±da)
olsun [cmd, yanit] = binproto::request(conn, 0x01, [0x10], 1000)
""")

// -----------------------------------------------------------------------------
// DeÄŸer Kodlama/Ã‡Ã¶zme
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ”¢ DeÄŸer Kodlama/Ã‡Ã¶zme:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
Desteklenen Tipler:
  u8, i8       - 8-bit (1 byte)
  u16, i16     - 16-bit (2 bytes, big-endian)
  u32, i32     - 32-bit (4 bytes, big-endian)
  f32, float   - IEEE 754 float (4 bytes)
  f64, double  - IEEE 754 double (8 bytes)
""")

yazdÄ±r("""
// DeÄŸer â†’ Byte dizisi
olsun bytes = binproto::encode_value(1000, "u16")
yazdÄ±r("1000 as u16: {:?}", bytes)  // [0x03, 0xE8]

olsun bytes = binproto::encode_value(3.14, "f32")
yazdÄ±r("3.14 as f32: {:?}", bytes)  // [0x40, 0x48, 0xF5, 0xC3]

olsun bytes = binproto::encode_value(-50, "i8")
yazdÄ±r("-50 as i8: {:?}", bytes)    // [0xCE]

// Byte dizisi â†’ DeÄŸer
olsun deger = binproto::decode_value([0x03, 0xE8], "u16")
yazdÄ±r("DeÄŸer: {}", deger)  // 1000

olsun sicaklik = binproto::decode_value([0x41, 0xC8, 0x00, 0x00], "f32")
yazdÄ±r("SÄ±caklÄ±k: {}", sicaklik)  // 25.0
""")

// -----------------------------------------------------------------------------
// Float Kodlama (Yeni!)
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ“ Float Kodlama (GeliÅŸmiÅŸ):")
yazdÄ±r("-" * 40)

yazdÄ±r("""
// Float formatlarÄ±
olsun bytes = binproto::encode_float(3.14159, "f32be")  // Big-endian
olsun bytes = binproto::encode_float(3.14159, "f32le")  // Little-endian
olsun bytes = binproto::encode_float(3.14159, "f64be")  // Double BE
olsun bytes = binproto::encode_float(3.14159, "f64le")  // Double LE

// Float Ã§Ã¶zme
olsun deger = binproto::decode_float(bytes, "f32be")
""")

// -----------------------------------------------------------------------------
// CRC Hesaplama
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ” CRC/Checksum Hesaplama:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
olsun veri = [0x01, 0x02, 0x03, 0x04, 0x05]

// XOR checksum
olsun xor_cs = binproto::calculate_crc(veri, "xor")
yazdÄ±r("XOR: 0x{:02X}", xor_cs)

// SUM checksum
olsun sum_cs = binproto::calculate_crc(veri, "sum")
yazdÄ±r("SUM: 0x{:02X}", sum_cs)

// CRC-16 Modbus
olsun crc16 = binproto::calculate_crc(veri, "crc16_modbus")
yazdÄ±r("CRC-16: 0x{:04X}", crc16)

// CRC-32
olsun crc32 = binproto::calculate_crc(veri, "crc32")
yazdÄ±r("CRC-32: 0x{:08X}", crc32)

// LRC (Longitudinal Redundancy Check)
olsun lrc = binproto::calculate_crc(veri, "lrc")
yazdÄ±r("LRC: 0x{:02X}", lrc)
""")

// -----------------------------------------------------------------------------
// Payload OluÅŸturma
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ“¦ Payload OluÅŸturma:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
// KarmaÅŸÄ±k payload oluÅŸtur
olsun payload = binproto::build_payload([
    [0x01, "u8"],           // Komut
    [1000, "u16"],          // DeÄŸer 1
    [25.5, "f32"],          // SÄ±caklÄ±k
    [0xDEADBEEF, "u32"]     // Magic number
])
yazdÄ±r("Payload: {:?}", payload)
// 1 + 2 + 4 + 4 = 11 bytes

// Paketi gÃ¶nder
binproto::send_raw(conn, payload)
""")

// -----------------------------------------------------------------------------
// Ä°statistikler
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸ“Š BaÄŸlantÄ± Ä°statistikleri:")
yazdÄ±r("-" * 40)

yazdÄ±r("""
olsun stats = binproto::get_stats(conn)
yazdÄ±r("RX buffer: {} bytes", stats["buffer_size"])
yazdÄ±r("Port: {}", stats["port"])

// Buffer temizle
binproto::flush(conn)
""")

// -----------------------------------------------------------------------------
// Tam Ã–rnek: SensÃ¶r AÄŸÄ± Gateway
// -----------------------------------------------------------------------------

yazdÄ±r("\nğŸŒ Tam Ã–rnek: SensÃ¶r AÄŸÄ± Gateway")
yazdÄ±r("-" * 40)

yazdÄ±r("""
kullan std::binproto

// Ã–zel sensÃ¶r protokolÃ¼
olsun proto = binproto::create_simple(
    [0xAA, 0x55],  // Header
    "crc16",       // CRC-16 checksum
    [0x0D]         // Footer
)

olsun gateway = binproto::open(proto, "COM6", 115200)

// Komut tanÄ±mlarÄ±
sabit CMD_READ_SENSOR  = 0x01
sabit CMD_SET_CONFIG   = 0x02
sabit CMD_RESET        = 0xFF

// 4 sensÃ¶r dÃ¼ÄŸÃ¼mÃ¼nÃ¼ sorgula
dÃ¶ngÃ¼ node_id iÃ§in 1..5 yap
    // SensÃ¶r okuma isteÄŸi: [NODE_ID, SENSOR_TYPE]
    olsun istek = binproto::build_payload([
        [node_id, "u8"],
        [0x01, "u8"]    // SÄ±caklÄ±k sensÃ¶rÃ¼
    ])
    
    olsun [cmd, yanit] = binproto::request(gateway, CMD_READ_SENSOR, istek, 500)
    
    eÄŸer cmd == CMD_READ_SENSOR ise
        olsun sicaklik = binproto::decode_value(yanit[0..4], "f32")
        olsun nem = binproto::decode_value(yanit[4..8], "f32")
        
        yazdÄ±r("DÃ¼ÄŸÃ¼m {}: {:.1f}Â°C, {:.0f}% nem", node_id, sicaklik, nem)
    deÄŸilse
        yazdÄ±r("DÃ¼ÄŸÃ¼m {}: YanÄ±t yok", node_id)
    son
son

binproto::close(gateway)
""")

yazdÄ±r("\nâœ… BinProto demo tamamlandÄ±!")
