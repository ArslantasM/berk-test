// =============================================================================
// BERK Hardware Bridge - Modbus SÄ±caklÄ±k SensÃ¶rÃ¼
// EndÃ¼striyel sensÃ¶r okuma Ã¶rneÄŸi
// =============================================================================

kullan std::modbus
kullan std::time

yazdÄ±r("=== Modbus SÄ±caklÄ±k MonitÃ¶rÃ¼ ===\n")

// -----------------------------------------------------------------------------
// YapÄ±landÄ±rma
// -----------------------------------------------------------------------------

sabit PORT = "COM4"        // RS485 adaptÃ¶r portu
sabit BAUD = 9600          // Baud rate
sabit SLAVE_ID = 1         // SensÃ¶r slave ID
sabit TEMP_REG = 0         // SÄ±caklÄ±k register adresi
sabit HUMID_REG = 1        // Nem register adresi
sabit INTERVAL = 2000      // Okuma aralÄ±ÄŸÄ± (ms)

// Alarm limitleri
sabit TEMP_HIGH = 30.0     // YÃ¼ksek sÄ±caklÄ±k alarmÄ±
sabit TEMP_LOW = 10.0      // DÃ¼ÅŸÃ¼k sÄ±caklÄ±k alarmÄ±
sabit HUMID_HIGH = 80.0    // YÃ¼ksek nem alarmÄ±

// -----------------------------------------------------------------------------
// Ana Program
// -----------------------------------------------------------------------------

yazdÄ±r("ğŸŒ¡ï¸  SÄ±caklÄ±k/Nem SensÃ¶rÃ¼")
yazdÄ±r("-" * 40)
yazdÄ±r("Port: {}", PORT)
yazdÄ±r("Slave ID: {}", SLAVE_ID)
yazdÄ±r("Okuma aralÄ±ÄŸÄ±: {} ms", INTERVAL)
yazdÄ±r("")

dene yap
    // SensÃ¶re baÄŸlan
    yazdÄ±r("ğŸ”Œ BaÄŸlanÄ±lÄ±yor...")
    olsun sensor = modbus::connect(PORT, BAUD, SLAVE_ID)
    yazdÄ±r("âœ“ BaÄŸlantÄ± baÅŸarÄ±lÄ±!")
    
    // Timeout ayarla
    modbus::set_timeout(sensor, 1000)
    
    // BaÄŸlantÄ± kontrolÃ¼
    eÄŸer modbus::is_connected(sensor) ise
        yazdÄ±r("âœ“ Sensor iletiÅŸim kuruldu")
    son
    
    yazdÄ±r("")
    yazdÄ±r("ğŸ“Š Ã–lÃ§Ã¼mler baÅŸlÄ±yor...")
    yazdÄ±r("   Ã‡Ä±kmak iÃ§in Ctrl+C")
    yazdÄ±r("-" * 50)
    yazdÄ±r("{:^12} {:^12} {:^12} {:^12}", "Zaman", "SÄ±caklÄ±k", "Nem", "Durum")
    yazdÄ±r("-" * 50)
    
    // Okuma sayacÄ±
    olsun okuma_sayisi = 0
    olsun hata_sayisi = 0
    
    // Ana dÃ¶ngÃ¼
    dÃ¶ngÃ¼ yap
        dene yap
            // SÄ±caklÄ±k oku (x10 format, Ã¶rn: 235 = 23.5Â°C)
            olsun temp_raw = modbus::read_holding_registers(sensor, TEMP_REG, 1)
            olsun sicaklik = temp_raw[0] / 10.0
            
            // Nem oku (x10 format)
            olsun humid_raw = modbus::read_holding_registers(sensor, HUMID_REG, 1)
            olsun nem = humid_raw[0] / 10.0
            
            // Zaman damgasÄ±
            olsun zaman = time::now_formatted("%H:%M:%S")
            
            // Durum belirleme
            olsun durum = "âœ“ Normal"
            eÄŸer sicaklik > TEMP_HIGH ise
                durum = "ğŸ”¥ SICAK!"
            yoksa eÄŸer sicaklik < TEMP_LOW ise
                durum = "â„ï¸ SOÄUK!"
            yoksa eÄŸer nem > HUMID_HIGH ise
                durum = "ğŸ’§ NEMLI!"
            son
            
            // Ekrana yazdÄ±r
            yazdÄ±r("{:^12} {:^10.1f}Â°C {:^10.1f}% {:^12}", 
                   zaman, sicaklik, nem, durum)
            
            okuma_sayisi = okuma_sayisi + 1
            
        yakala err yap
            olsun zaman = time::now_formatted("%H:%M:%S")
            yazdÄ±r("{:^12} {:^12} {:^12} âŒ HATA", zaman, "---", "---")
            hata_sayisi = hata_sayisi + 1
            
            // Ã‡ok fazla hata varsa baÄŸlantÄ±yÄ± yeniden dene
            eÄŸer hata_sayisi > 5 ise
                yazdÄ±r("\nâš ï¸  Ã‡ok fazla hata! BaÄŸlantÄ± kontrol ediliyor...")
                hata_sayisi = 0
            son
        son
        
        bekle(INTERVAL)
    son
    
    // Temizlik
    modbus::disconnect(sensor)
    yazdÄ±r("\nâœ“ BaÄŸlantÄ± kapatÄ±ldÄ±.")
    yazdÄ±r("  Toplam okuma: {}", okuma_sayisi)
    
yakala hata yap
    yazdÄ±r("\nâŒ BAÄLANTI HATASI: {}", hata)
    yazdÄ±r("")
    yazdÄ±r("Kontrol edin:")
    yazdÄ±r("  1. RS485 adaptÃ¶r baÄŸlÄ± mÄ±?")
    yazdÄ±r("  2. A/B kablolarÄ±nÄ± doÄŸru mu?")
    yazdÄ±r("  3. Slave ID {} doÄŸru mu?", SLAVE_ID)
    yazdÄ±r("  4. Baud rate {} doÄŸru mu?", BAUD)
son
